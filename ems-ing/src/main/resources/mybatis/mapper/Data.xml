<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.markcha.ems.mapper.analysis.DataMapper">
    <select id="getHistoryHour" resultType="java.util.LinkedHashMap" parameterType="com.markcha.ems.mapper.analysis.HistorySearchDto">
        SELECT
                if(s.h = 0, 24, s.h) AS #{timeType}
            <if test="usageType.equals('Usage')">
                ,ifnull(shr.`USAGE`, 0)        AS     #{usageType}
                ,ifnull(`bf`.`USAGE`, 0) AS         #{beforeOneDay}
                ,ifnull(`LY`.`USAGE`, 0)     AS     #{beforeOneYear}
                <if test="isDuo.equals(true)">
                    ,ifnull(`EY`.`USAGE`, 0)     AS     `kWh`
                </if>
            </if>

            <if test="usageType.equals('TOE')">
                , ROUND(IFNULL(((`shr`.`usage` * 0.001) *(formula.TOE)), 0), 5) #{usageType}
                , ROUND(IFNULL(((`bf`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{beforeOneDay}
                , ROUND(IFNULL(((`LY`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{beforeOneYear}
                <if test="isDuo.equals(true)">
                    ,ROUND(IFNULL(((`EY`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{kWh}
                </if>
            </if>

            <if test="usageType.equals('tCo2')">
                , ROUND(IFNULL(((`shr`.`usage` * 0.001) *(formula.tCo2)), 0), 5) #{usageType}
                , ROUND(IFNULL(((`bf`.`usage` * 0.001) * (formula.tCo2)), 0), 5) #{beforeOneDay}
                , ROUND(IFNULL(((`LY`.`usage` * 0.001) * (formula.tCo2)), 0), 5) #{beforeOneYear}
                <if test="isDuo.equals(true)">
                    ,ROUND(IFNULL(((`EY`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{kWh}
                </if>
            </if>

        FROM
        (SELECT `toe`,`tco2`, `usage` FROM energy WHERE energy_id=28) formula,
        (SELECT logvalue AS h FROM `tagdata`.sources_hour_with_day WHERE logvalue <![CDATA[>=]]> 0 AND logvalue <![CDATA[<=]]> 23) s
        LEFT JOIN
        (SELECT HOUR(`TIMESTAMP` + INTERVAL 1 HOUR) h, sum(`USAGE`) `usage`, TIMESTAMP, tagname
        FROM `tagdata`.history_hour
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
        AND timestamp <![CDATA[>]]> #{startDate}
        AND TIMESTAMP <![CDATA[<=]]> #{endDate}
        group by hour(`TIMESTAMP`)
        ) shr ON shr.h = s.h
        LEFT JOIN
        (SELECT HOUR(`TIMESTAMP` + INTERVAL 1 HOUR) h, sum(`USAGE`) `usage`, TIMESTAMP, tagname
        FROM `tagdata`.history_hour
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
        AND timestamp <![CDATA[>]]> #{startDate}
        AND TIMESTAMP <![CDATA[<=]]> #{endDate}
        group by hour(`TIMESTAMP`)
        ) `bf` ON `bf`.h = s.h
        LEFT JOIN
        (SELECT HOUR(`TIMESTAMP` + INTERVAL 1 HOUR) h, sum(`USAGE`) `usage`, TIMESTAMP, tagname
        FROM `tagdata`.history_hour
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
        AND timestamp <![CDATA[>]]> #{startDate}
        AND TIMESTAMP <![CDATA[<=]]> #{endDate}
        group by hour(`TIMESTAMP`)
        ) `LY` ON `LY`.h = s.h
        <if test="isDuo.equals(true)">
            LEFT JOIN
            (SELECT HOUR(`TIMESTAMP` + INTERVAL 1 HOUR) h, sum(`USAGE`) `usage`, TIMESTAMP, tagname
            FROM `tagdata`.history_hour
            WHERE tagname in
            <foreach collection="secondTagNames" item="secondtagname" index="index" separator="," open="(" close=")">
                #{secondtagname}
            </foreach>
            AND timestamp <![CDATA[>]]> #{startDate}
            AND TIMESTAMP <![CDATA[<=]]> #{endDate}
            group by hour(`TIMESTAMP`)
            ) `EY` ON `EY`.h = s.h
        </if>
        ORDER BY if(s.h = 0, 24, s.h)

    </select>
    <select id="getHistoryDay" resultType="java.util.LinkedHashMap" parameterType="com.markcha.ems.mapper.analysis.HistorySearchDto">
        SELECT
        s.d AS #{timeType}
        <if test="usageType.equals('Usage')">
            ,ifnull(shr.`USAGE`, 0)        AS     #{usageType}
            ,ifnull(`bf`.`USAGE`, 0) AS         #{beforeOneDay}
            ,ifnull(`LY`.`USAGE`, 0)     AS     #{beforeOneYear}
            <if test="isDuo.equals(true)">
                ,ifnull(`EY`.`USAGE`, 0)     AS     `kWh`
            </if>
        </if>

        <if test="usageType.equals('TOE')">
            , ROUND(IFNULL(((`shr`.`usage` * 0.001) *(formula.TOE)), 0), 5) #{usageType}
            , ROUND(IFNULL(((`bf`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{beforeOneDay}
            , ROUND(IFNULL(((`LY`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{beforeOneYear}
            <if test="isDuo.equals(true)">
                ,ROUND(IFNULL(((`EY`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{kWh}
            </if>
        </if>

        <if test="usageType.equals('tCo2')">
            , ROUND(IFNULL(((`shr`.`usage` * 0.001) *(formula.tCo2)), 0), 5) #{usageType}
            , ROUND(IFNULL(((`bf`.`usage` * 0.001) * (formula.tCo2)), 0), 5) #{beforeOneDay}
            , ROUND(IFNULL(((`LY`.`usage` * 0.001) * (formula.tCo2)), 0), 5) #{beforeOneYear}
            <if test="isDuo.equals(true)">
                ,ROUND(IFNULL(((`EY`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{kWh}
            </if>
        </if>

        FROM
        (SELECT `toe`,`tco2`, `usage` FROM energy WHERE energy_id=28) formula,
        (SELECT logvalue AS d FROM `tagdata`.sources_hour_with_day WHERE logvalue <![CDATA[>=]]> 1 AND logvalue <![CDATA[<=]]> last_day(#{startDate})) s
        LEFT JOIN
        (SELECT day(`TIMESTAMP`) d, sum(`USAGE`) `usage`, TIMESTAMP, tagname
        FROM `tagdata`.history_day
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>

        AND timestamp <![CDATA[>=]]> #{startDate}
        AND TIMESTAMP <![CDATA[<]]> #{endDate}

        group by day(`TIMESTAMP`)
        ) shr ON shr.d = s.d
        LEFT JOIN
        (SELECT day(`TIMESTAMP`) d, sum(`USAGE`) `usage`, TIMESTAMP, tagname
        FROM `tagdata`.history_day
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
        group by day(`TIMESTAMP`)
        ) `bf` ON DATE_ADD(shr.timestamp, INTERVAL -1 DAY) = `bf`.timestamp
        LEFT JOIN
        (SELECT day(`TIMESTAMP`) d,sum(`USAGE`) `usage`, TIMESTAMP, tagname
        FROM `tagdata`.history_day
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
        group by day(`TIMESTAMP`)
        ) `LY` ON DATE_ADD(shr.timestamp, INTERVAL -1 year) = `LY`.timestamp
        <if test="isDuo.equals(true)">
            LEFT JOIN
            (SELECT HOUR(`TIMESTAMP` + INTERVAL 1 HOUR) h, sum(`USAGE`) `usage`, TIMESTAMP, tagname
            FROM `tagdata`.history_hour
            WHERE tagname in
            <foreach collection="secondTagNames" item="secondtagname" index="index" separator="," open="(" close=")">
                #{secondtagname}
            </foreach>
            AND timestamp <![CDATA[>]]> #{startDate}
            AND TIMESTAMP <![CDATA[<=]]> #{endDate}
            group by hour(`TIMESTAMP`)
            ) `EY` ON `EY`.h = s.h
        </if>
        ORDER BY if(s.d = 0, 24, s.d)

    </select>
    <select id="getHistoryMonth" resultType="java.util.LinkedHashMap" parameterType="com.markcha.ems.mapper.analysis.HistorySearchDto">
        SELECT
        s.m AS #{timeType}
        <if test="usageType.equals('Usage')">
            ,ifnull(shr.`USAGE`, 0)        AS     #{usageType}
            ,ifnull(`bf`.`USAGE`, 0) AS         #{beforeOneYear}
        </if>

        <if test="usageType.equals('TOE')">
            , ROUND(IFNULL(((`shr`.`usage` * 0.001) *(formula.TOE)), 0), 5) #{usageType}
            , ROUND(IFNULL(((`bf`.`usage` * 0.001) * (formula.TOE)), 0), 5) #{beforeOneYear}
        </if>

        <if test="usageType.equals('tCo2')">
            , ROUND(IFNULL(((`shr`.`usage` * 0.001) *(formula.tCo2)), 0), 5) #{usageType}
            , ROUND(IFNULL(((`bf`.`usage` * 0.001) * (formula.tCo2)), 0), 5) #{beforeOneYear}
        </if>

        FROM
        (SELECT `toe`,`tco2`, `usage` FROM energy WHERE energy_id=28) formula,
        (SELECT logvalue AS m FROM `tagdata`.sources_hour_with_day WHERE logvalue <![CDATA[>=]]> 1 AND logvalue <![CDATA[<=]]> 12) s
        LEFT JOIN
        (SELECT month(`TIMESTAMP`) m, sum(`USAGE`) `usage`, TIMESTAMP, tagname
        FROM `tagdata`.history_day
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
        AND timestamp <![CDATA[>=]]> #{startDate}
        AND TIMESTAMP <![CDATA[<]]> #{endDate}

        group by month(`TIMESTAMP`)
        ) shr ON shr.m = s.m
        LEFT JOIN
        (SELECT month(`TIMESTAMP`) m, sum(`USAGE`) `usage`, TIMESTAMP, tagname
        FROM `tagdata`.history_day
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
        group by month(`TIMESTAMP`)
        ) `bf` ON DATE_ADD(shr.timestamp, INTERVAL -1 year) = `bf`.timestamp

    </select>

    <select id="getHistoryYear" resultType="java.util.LinkedHashMap" parameterType="com.markcha.ems.mapper.analysis.HistorySearchDto">
        SELECT year(`timestamp`) y

        <if test="usageType.equals('Usage')">
            ,if(tagname like '%PF%', avg(`usage`),sum(`usage`)) #{usageType}
        </if>

        <if test="usageType.equals('TOE')">
            , ROUND(IFNULL((sum(`usage`) * 0.001) * (formula.tCo2, 0), 5) AS #{usageType}
        </if>

        <if test="usageType.equals('tCo2')">
            , ROUND(IFNULL((sum(`usage`) * 0.001) * (formula.tCo2, 0), 5) AS #{usageType}
        </if>
        
        
        FROM (
        SELECT `toe`,`tco2`
        FROM energy
        WHERE energy_id=28) formula,
        `tagdata`.history_day
        where tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
        and `timestamp` <![CDATA[>]]> #{startDate} AND
        `timestamp` <![CDATA[<=]]> #{endDate}
        group by year(`timestamp`);
    </select>

    <select id="getHistoryMin" resultType="java.util.LinkedHashMap" parameterType="com.markcha.ems.mapper.analysis.HistorySearchDto">

        SELECT

            if(s.f='00:00', '24:00:00',s.f) AS `H`
            <if test="usageType.equals('Usage') or usageType.equals('PF')">
                , IFNULL(f.kWh,0) AS #{usageType}
                , IFNULL(f.kW,0) AS `kW`
                , IFNULL(b.kWh,0) AS #{beforeOneDay}
                , IFNULL(b.kW,0) AS `beforekW`
            </if>

            <if test="usageType.equals('TOE')">
                , ROUND(IFNULL(((`kWh` * 0.001) * (formula.TOE)), 0), 5) AS #{usageType}
            </if>
            <if test="usageType.equals('tCo2')">
                , ROUND(IFNULL(((`kWh` * 0.001) * (formula.tCo2)), 0), 5) AS #{usageType}
            </if>
        FROM
            (select logvalue as f from `tagdata`.sources_quarter_past) s
        left join (SELECT time(from_unixtime(ceil(UNIX_TIMESTAMP(`timestamp`)/900)*900))t,tagname AS tagname,
        <if test="usageType.equals('PF')">
            if(tagname like '%PF%', avg(`usage`),sum(`usage`)) AS kWh,
            if(tagname like '%PF%', avg(`usage`),sum(`usage`)*4) AS kW
        </if>
        <if test="usageType.equals('Usage')">
            SUM(`usage`) AS kWh, SUM(`usage`)*4 as kW
        </if>
        FROM `tagdata`.history
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
         AND
        `timestamp` <![CDATA[>]]> #{startDate} AND
        `timestamp` <![CDATA[<=]]> #{endDate}
        group by t) f on s.f = f.t
        left join (SELECT time(from_unixtime(ceil(UNIX_TIMESTAMP(`timestamp`)/900)*900))t,tagname AS tagname,
        <if test="usageType.equals('PF')">
            if(tagname like '%PF%', avg(`usage`),sum(`usage`)) AS kWh,
            if(tagname like '%PF%', avg(`usage`),sum(`usage`)*4) AS kW
        </if>
        <if test="usageType.equals('Usage')">
            SUM(`usage`) AS kWh, SUM(`usage`)*4 as kW
        </if>
        FROM `tagdata`.history
        WHERE tagname in
        <foreach collection="tagNames" item="tagname" index="index" separator="," open="(" close=")">
            #{tagname}
        </foreach>
         AND
        `timestamp` <![CDATA[>]]> #{startDate} AND
        `timestamp` <![CDATA[<=]]> #{endDate}
        group by t) b on s.f = b.t
        ORDER BY `H`
    </select>
</mapper>